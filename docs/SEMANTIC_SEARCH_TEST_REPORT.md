# Отчет о проверке семантического поиска

**Author**: Vasiliy Zdanovskiy  
**Email**: vasilyvz@gmail.com  
**Date**: 2025-12-30

## Статус векторизации

✅ **Все чанки векторизованы**:
- Всего чанков: 10,015
- Векторизовано: 10,015 (100%)
- Не векторизовано: 0

## Тестирование семантического поиска

### Тест 1: Простой запрос

**Запрос**: `"test"`  
**min_score**: 0  
**Результат**: ✅ Работает, возвращает 5 результатов

**Наблюдения**:
- Поиск технически работает
- Возвращает результаты из `test_data/bhlff_mcp_test/`
- Все результаты имеют тип `DocBlock` (докстринги)

### Тест 2: Запрос по CUDA backend

**Запрос**: `"CUDA backend initialization with device and memory pool"`  
**min_score**: 0.3  
**Результат**: ⚠️ Работает, но результаты не релевантны

**Проблемы**:
- ❌ Не находит код из `utils/cuda_backend.py`
- ❌ Результаты не связаны с CUDA backend
- ❌ Все результаты из `test_data/bhlff_mcp_test/`, не из основного проекта

**Примеры результатов**:
- `gradient_computer.py` - про градиенты, не про CUDA
- `analyzer.py` - про анализ, не про backend
- `postulate.py` - про постулаты, не про инициализацию

### Тест 3: Запрос по FFT

**Запрос**: `"FFT transform array with axes parameter"`  
**min_score**: 0.3  
**Результат**: ⚠️ Работает, но результаты не релевантны

**Проблемы**:
- ❌ Не находит методы `fft()` из `cuda_backend.py` или `cpu_backend.py`
- ❌ Результаты не связаны с FFT операциями
- ❌ Все результаты из `test_data/`, не из основного проекта

### Тест 4: Запрос по базе данных

**Запрос**: `"database connection and SQL query execution"`  
**min_score**: 0.3  
**Результат**: ⚠️ Работает, но результаты не релевантны

**Проблемы**:
- ❌ Не находит код из `code_analysis/core/database/`
- ❌ Результаты не связаны с базой данных
- ❌ Все результаты из `test_data/`, не из основного проекта

### Тест 5: Запрос по рефакторингу

**Запрос**: `"split large class into smaller classes"`  
**min_score**: 0.3  
**Результат**: ⚠️ Работает, но результаты не релевантны

**Проблемы**:
- ❌ Не находит код из `code_analysis/core/refactorer_pkg/`
- ❌ Результаты не связаны с рефакторингом
- ❌ Все результаты из `test_data/`, не из основного проекта

## Анализ проблем

### Проблема 1: Псевдо-эмбеддинги для запросов

**Найдено в коде** (`semantic_search_mcp.py:184-190`):
```python
digest = hashlib.sha256(query.encode("utf-8")).digest()
seed = int.from_bytes(digest[:8], "little", signed=False)
rng = np.random.default_rng(seed)
query_vec = rng.standard_normal(vector_dim).astype("float32")
```

**Проблема**: 
- Запросы векторизуются через **псевдо-эмбеддинг** (детерминированный вектор из хеша)
- Чанки векторизованы через **реальный embedding сервис**
- Это создает **несоответствие** между запросами и чанками

**Последствия**:
- Низкое качество результатов
- Плохая релевантность
- Результаты не соответствуют запросам

### Проблема 2: Результаты только из test_data

**Наблюдение**: Все результаты из `test_data/bhlff_mcp_test/`, не из основного проекта `code_analysis/`.

**Возможные причины**:
1. В основном проекте меньше докстрингов
2. Докстринги в основном проекте менее детальные
3. Проблема с индексацией основного проекта

### Проблема 3: Низкие scores

**Наблюдение**: Все scores в диапазоне 0.36-0.38, что указывает на низкую релевантность.

**Ожидаемое поведение**:
- Релевантные результаты должны иметь score > 0.7
- Нерелевантные результаты должны иметь score < 0.5

## Рекомендации

### Краткосрочные (критично)

1. **Использовать реальный embedding сервис для запросов**:
   - Заменить псевдо-эмбеддинг на реальный embedding
   - Использовать тот же сервис, что и для векторизации чанков
   - Это критично для качества поиска

2. **Проверить индексацию основного проекта**:
   - Убедиться, что чанки из `code_analysis/` добавлены в FAISS
   - Проверить, что `vector_id` правильно установлены

### Долгосрочные

1. **Улучшить качество embeddings**:
   - Использовать более качественную модель
   - Fine-tuning под код Python
   - Специализированные embeddings для кода

2. **Добавить фильтрацию результатов**:
   - Фильтр по `file_path` (исключить `test_data/`)
   - Фильтр по `chunk_type` (только `DocBlock` или все)
   - Фильтр по проекту

3. **Улучшить ранжирование**:
   - Комбинировать semantic search с fulltext search
   - Использовать BM25 для релевантности
   - Добавить boost для определенных типов чанков

## Выводы

✅ **Технически работает**: Поиск возвращает результаты  
⚠️ **Качество низкое**: Результаты не релевантны запросам  
❌ **Критическая проблема**: Используются псевдо-эмбеддинги вместо реальных

**Главная проблема**: Запросы векторизуются через псевдо-эмбеддинг (хеш), а чанки через реальный embedding сервис. Это создает несоответствие и низкое качество результатов.

**Решение**: Использовать реальный embedding сервис для векторизации запросов, тот же, что используется для векторизации чанков.

## Реализованные исправления

### ✅ Обновлен SVOClientManager

**Изменения**:
- Добавлена поддержка реального `EmbeddingServiceAsyncClient` из `embed_client`
- Чтение конфигурации embedding из `code_analysis.embedding`:
  - `url` / `host` - URL сервиса
  - `port` - порт сервиса
  - `protocol` - протокол (http, https, mtls)
  - `cert_file`, `key_file`, `ca_cert_file`, `crl_file` - сертификаты для mTLS
  - `timeout` - таймаут запросов
- Автоматическое создание клиента через `ClientFactory` на основе протокола
- Обработка относительных путей к сертификатам
- Fallback на псевдо-эмбеддинги при недоступности сервиса

### ✅ Обновлен semantic_search_mcp.py

**Изменения**:
- Использует реальный embedding сервис через `SVOClientManager` для векторизации запросов
- Fallback на псевдо-эмбеддинги только при недоступности сервиса
- Правильное чтение конфигурации из `config.json`

### Конфигурация

Конфигурация embedding уже присутствует в `config.json`:

```json
{
  "code_analysis": {
    "embedding": {
      "enabled": true,
      "url": "localhost",
      "port": 8001,
      "protocol": "mtls",
      "cert_file": "mtls_certificates/.../client/code-analysis.crt",
      "key_file": "mtls_certificates/.../client/code-analysis.key",
      "ca_cert_file": "mtls_certificates/.../ca/ca.crt",
      "crl_file": null,
      "timeout": 60.0
    }
  }
}
```

**Структура аналогична chunker**:
- URL и порт
- Протокол (http/https/mtls)
- Настройки соединения (сертификаты, ключ, CRL)

### Результат

Теперь семантический поиск использует **реальный embedding сервис** для векторизации запросов, что должно значительно улучшить качество результатов поиска.

