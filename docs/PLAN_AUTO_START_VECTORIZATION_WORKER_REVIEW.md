# Plan Review: Auto-start Vectorization Worker for New Projects

**Author**: Vasiliy Zdanovskiy  
**email**: vasilyvz@gmail.com  
**Date**: 2026-01-09  
**Review Date**: 2026-01-09

## Overall Assessment

–ü–ª–∞–Ω –≤ —Ü–µ–ª–æ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –û–¥–Ω–∞–∫–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π** —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞.

## ‚úÖ –ß—Ç–æ —É—á—Ç–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

1. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `project_id` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–æ—Ä–∫–µ—Ä–∞
2. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `watch_dirs` –≤ –≤–æ—Ä–∫–µ—Ä–µ
3. ‚úÖ –†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã)
4. ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
5. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
6. ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å file watcher –∏ vectorization worker

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

### 1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã FAISS –∏–Ω–¥–µ–∫—Å–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–ª–∞–Ω –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç **–æ–¥–∏–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π FAISS –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤**, –Ω–æ —Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **dataset-scoped –∏–Ω–¥–µ–∫—Å—ã** (–æ–¥–∏–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ dataset).

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
- –ö–∞–∂–¥—ã–π dataset –∏–º–µ–µ—Ç —Å–≤–æ–π FAISS –∏–Ω–¥–µ–∫—Å —Ñ–∞–π–ª: `{faiss_dir}/{project_id}/{dataset_id}.bin`
- –ú–µ—Ç–æ–¥ `get_faiss_index_path(faiss_dir, project_id, dataset_id)` —Å–æ–∑–¥–∞–µ—Ç –ø—É—Ç—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ dataset
- `FaissIndexManager` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–¥–Ω–∏–º –∏–Ω–¥–µ–∫—Å–æ–º —Ñ–∞–π–ª–æ–º –∑–∞ —Ä–∞–∑
- `rebuild_from_database()` –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ project_id/dataset_id, –Ω–æ —ç—Ç–æ "legacy mode"

**–ß—Ç–æ –≤ –ø–ª–∞–Ω–µ**:
- Step 3: "Single FAISS Manager for All Projects" - –æ–¥–∏–Ω –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- Step 5: "FAISS Index Rebuild Strategy" - –æ–¥–∏–Ω —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
- Note 352: "FAISS index is unified - one index for all projects"

**–†–µ—à–µ–Ω–∏–µ**: –ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

**–í–∞—Ä–∏–∞–Ω—Ç A: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å dataset-scoped –∏–Ω–¥–µ–∫—Å—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
- Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≤–æ–π FAISS manager (–∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ index_path)
- –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–µ**:
  - Step 3: –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ "FAISS Manager per Dataset" –∏–ª–∏ "Dynamic FAISS Manager switching"
  - Step 5: –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ (–Ω–µ –æ–¥–∏–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
  - –£—Ç–æ—á–Ω–∏—Ç—å, —á—Ç–æ worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ–µ–∫—Ç–µ

**–í–∞—Ä–∏–∞–Ω—Ç B: –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)**
- –û–¥–∏–Ω FAISS –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- –¢—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ `get_faiss_index_path()` –∏ –≤—Å–µ–π –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö dataset-scoped –∏–Ω–¥–µ–∫—Å–æ–≤
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–µ**:
  - –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
  - –ò–∑–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è dataset-scoped –ø—É—Ç—å –∫ –∏–Ω–¥–µ–∫—Å—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í–∞—Ä–∏–∞–Ω—Ç A (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å dataset-scoped), —Ç–∞–∫ –∫–∞–∫:
- –ú–µ–Ω—å—à–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –ò–∑–±–µ–≥–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
- Dataset-scoped –∏–Ω–¥–µ–∫—Å—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –ª—É—á—à—É—é —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –Ω–µ —É—á—Ç–µ–Ω–∞**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–ª–∞–Ω –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **–≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ–µ–∫—Ç–µ**.

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ö–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- –ú–µ—Ç–æ–¥ `database.get_project_datasets(project_id)` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
- –ú–µ—Ç–æ–¥—ã `get_files_needing_chunking(project_id)` –∏ `get_non_vectorized_chunks(project_id, dataset_id=None)` —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞

**–ß—Ç–æ –≤ –ø–ª–∞–Ω–µ**:
- Step 2: "For each project in sorted list" - –Ω–æ –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- Step 1: `get_projects_with_vectorization_count()` - –Ω–µ —è—Å–Ω–æ, —É—á–∏—Ç—ã–≤–∞–µ—Ç –ª–∏ –¥–∞—Ç–∞—Å–µ—Ç—ã

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω:

**Step 1 (—É—Ç–æ—á–Ω–µ–Ω–∏–µ)**:
- –ú–µ—Ç–æ–¥ `get_projects_with_vectorization_count()` –¥–æ–ª–∂–µ–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö
- –ü–æ–¥—Å—á–µ—Ç: —Å—É–º–º–∞ –ø–æ –≤—Å–µ–º –¥–∞—Ç–∞—Å–µ—Ç–∞–º –ø—Ä–æ–µ–∫—Ç–∞ (—Ñ–∞–π–ª—ã + —á–∞–Ω–∫–∏)

**Step 2 (—É—Ç–æ—á–Ω–µ–Ω–∏–µ)**:
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã: `database.get_project_datasets(project_id)`
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞:
  - –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è —á–∞–Ω–∫–∏–Ω–≥–∞: `database.get_files_needing_chunking(project_id)` (—É–∂–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
  - –ü–æ–ª—É—á–∏—Ç—å —á–∞–Ω–∫–∏ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: `database.get_non_vectorized_chunks(project_id, dataset_id=dataset_id)`
  - –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª—ã –∏ —á–∞–Ω–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π FAISS manager –¥–ª—è —ç—Ç–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞

### 3. **–ú–µ—Ç–æ–¥ get_projects_with_vectorization_count() - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ç–∞–ª–µ–π**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í Step 1 –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ —Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤/—á–∞–Ω–∫–æ–≤.

**–¢–µ–∫—É—â–∏–µ –º–µ—Ç–æ–¥—ã**:
- `get_files_needing_chunking(project_id, limit=10)` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (—É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã)
- `get_non_vectorized_chunks(project_id, dataset_id=None, limit=10)` - –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ dataset_id –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞

**–†–µ—à–µ–Ω–∏–µ**: –£—Ç–æ—á–Ω–∏—Ç—å –≤ Step 1:

```sql
-- –ü—Ä–∏–º–µ—Ä SQL –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ (–Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å):
SELECT 
    p.id AS project_id,
    p.root_path,
    (
        -- Count files needing chunking
        (SELECT COUNT(DISTINCT f.id)
         FROM files f
         WHERE f.project_id = p.id
           AND (f.deleted = 0 OR f.deleted IS NULL)
           AND (f.has_docstring = 1 OR ...)
           AND NOT EXISTS (SELECT 1 FROM code_chunks cc WHERE cc.file_id = f.id))
        +
        -- Count chunks needing vectorization
        (SELECT COUNT(cc.id)
         FROM code_chunks cc
         INNER JOIN files f ON cc.file_id = f.id
         WHERE cc.project_id = p.id
           AND (f.deleted = 0 OR f.deleted IS NULL)
           AND cc.embedding_vector IS NOT NULL
           AND cc.vector_id IS NULL)
    ) AS pending_count
FROM projects p
WHERE pending_count > 0
ORDER BY pending_count ASC
```

### 4. **Worker registration –≤ WorkerManager**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í `main.py` –∏ `worker_launcher.py` –≤–æ—Ä–∫–µ—Ä—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —Å –∏–º–µ–Ω–∞–º–∏, –≤–∫–ª—é—á–∞—é—â–∏–º–∏ `project_id` –∏ `dataset_id`:
- `f"vectorization_{project_id}"`
- `f"vectorization_{project_id}_{dataset_id[:8]}"`

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –≤ Step 6:
- –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –≤–æ—Ä–∫–µ—Ä–∞ –Ω–∞ `"vectorization_universal"` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `"vectorization"`
- –û–±–Ω–æ–≤–∏—Ç—å `worker_launcher.py` –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞

### 5. **FAISS index path –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å dataset-scoped –∏–Ω–¥–µ–∫—Å—ã, –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—É—Ç—å –∫ –∏–Ω–¥–µ–∫—Å—É –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –≤–æ—Ä–∫–µ—Ä–µ.

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- `run_vectorization_worker()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `faiss_index_path` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
- –í —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–¥–Ω–æ–≥–æ –ø—É—Ç–∏

**–†–µ—à–µ–Ω–∏–µ**: 
- **–í–∞—Ä–∏–∞–Ω—Ç A (dataset-scoped)**: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `faiss_dir` –≤–º–µ—Å—Ç–æ `faiss_index_path`, —Å–æ–∑–¥–∞–≤–∞—Ç—å FAISS manager –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞
- **–í–∞—Ä–∏–∞–Ω—Ç B (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å)**: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –æ–¥–∏–Ω –ø—É—Ç—å –∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º—É –∏–Ω–¥–µ–∫—Å—É

### 6. **–ú–µ—Ç–æ–¥ get_non_vectorized_chunks() —Ç—Ä–µ–±—É–µ—Ç project_id**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í Step 2 —É–∫–∞–∑–∞–Ω–æ `database.get_non_vectorized_chunks(project_id)`, –Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –∏–ª–∏ –±–µ–∑ dataset_id.

**–†–µ—à–µ–Ω–∏–µ**: –£—Ç–æ—á–Ω–∏—Ç—å –≤ Step 2:
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞: `database.get_non_vectorized_chunks(project_id, dataset_id=dataset_id)`
- –ò–ª–∏ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞: `database.get_non_vectorized_chunks(project_id, dataset_id=None)`

### 7. **–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ FAISS –∏–Ω–¥–µ–∫—Å–∞**

**–ü—Ä–æ–±–ª–µ–º–∞**: Step 5 –≥–æ–≤–æ—Ä–∏—Ç –æ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–µ –æ–¥–Ω–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞, –Ω–æ –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å dataset-scoped, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –∫–∞–∂–¥—ã–π –∏–Ω–¥–µ–∫—Å –æ—Ç–¥–µ–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**: –£—Ç–æ—á–Ω–∏—Ç—å –≤ Step 5:
- –ï—Å–ª–∏ dataset-scoped: –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—É—é –∑–∞–º–µ–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å —Ñ–∞–π–ª–∞
- –ò–ª–∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø–ª–∞–Ω–∞

### 1. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "Architecture Decision: FAISS Index Strategy"

–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ç–∫–æ:
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å dataset-scoped –∏–Ω–¥–µ–∫—Å—ã –∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π
- –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞
- –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –º–µ–Ω—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É)

### 2. –£—Ç–æ—á–Ω–∏—Ç—å Step 1

–î–æ–±–∞–≤–∏—Ç—å:
- SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ (–∏–ª–∏ –ø—Å–µ–≤–¥–æ–∫–æ–¥)
- –£—á–µ—Ç –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –ø–æ–ª—è: `project_id`, `root_path`, `pending_count`, –≤–æ–∑–º–æ–∂–Ω–æ `dataset_count`

### 3. –£—Ç–æ—á–Ω–∏—Ç—å Step 2

–î–æ–±–∞–≤–∏—Ç—å:
- –û–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ–µ–∫—Ç–µ
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤: `database.get_project_datasets(project_id)`
- –û–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ FAISS manager –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞

### 4. –£—Ç–æ—á–Ω–∏—Ç—å Step 3

–ï—Å–ª–∏ dataset-scoped:
- –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ "FAISS Manager Management Strategy"
- –û–ø–∏—Å–∞—Ç—å, –∫–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ FAISS managers (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç)
- –ò–ª–∏ –æ–ø–∏—Å–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ index_path

### 5. –£—Ç–æ—á–Ω–∏—Ç—å Step 5

–ï—Å–ª–∏ dataset-scoped:
- –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- –û–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∞—Ç–æ–º–∞—Ä–Ω–æ–π –∑–∞–º–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å —Ñ–∞–π–ª–∞
- –í–æ–∑–º–æ–∂–Ω–æ, –¥–æ–±–∞–≤–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é: –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

### 6. –î–æ–±–∞–≤–∏—Ç—å –≤ Edge Cases

- **Dataset deleted while processing**: Worker should skip deleted datasets
- **Multiple datasets per project**: Worker should process all datasets sequentially
- **FAISS index path resolution**: How to determine index path for each dataset dynamically

### 7. –û–±–Ω–æ–≤–∏—Ç—å Files to Modify

–î–æ–±–∞–≤–∏—Ç—å:
- `code_analysis/core/worker_launcher.py` - –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤–æ—Ä–∫–µ—Ä–∞
- `code_analysis/core/storage_paths.py` - –≤–æ–∑–º–æ–∂–Ω–æ, –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç B)

## ‚úÖ –ß—Ç–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å

1. ‚úÖ –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞–Ω–∞
2. ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ (—Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è–º–∏)
3. ‚úÖ Edge cases (—Å –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏)
4. ‚úÖ Code Cleanup Checklist
5. ‚úÖ Testing scenarios

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ö—Ä–∏—Ç–∏—á–Ω–æ**: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é FAISS –∏–Ω–¥–µ–∫—Å–æ–≤ (dataset-scoped vs —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
2. **–ö—Ä–∏—Ç–∏—á–Ω–æ**: –£—Ç–æ—á–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –≤–æ –≤—Å–µ—Ö —à–∞–≥–∞—Ö
3. **–í–∞–∂–Ω–æ**: –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ SQL –∑–∞–ø—Ä–æ—Å–∞ –≤ Step 1
4. **–í–∞–∂–Ω–æ**: –£—Ç–æ—á–Ω–∏—Ç—å worker registration –≤ Step 6
5. **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**: –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è FAISS –∏–Ω–¥–µ–∫—Å–æ–≤ (dataset-scoped –∏–ª–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
- [ ] –£—Ç–æ—á–Ω–µ–Ω –ø–ª–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ SQL –∑–∞–ø—Ä–æ—Å–∞ –≤ Step 1
- [ ] –£—Ç–æ—á–Ω–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è FAISS manager –≤ Step 3
- [ ] –£—Ç–æ—á–Ω–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ Step 5
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã edge cases –¥–ª—è –¥–∞—Ç–∞—Å–µ—Ç–æ–≤

