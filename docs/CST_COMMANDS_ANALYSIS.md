# –ê–Ω–∞–ª–∏–∑ CST –∫–æ–º–∞–Ω–¥ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

**Author:** Vasiliy Zdanovskiy  
**email:** vasilyvz@gmail.com  
**Date:** 2025-01-27

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_parse_code_snippet()`:
   - –ü–∞—Ä—Å–∏—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –±–ª–æ–∫–∏ (try/except, imports, —Ñ—É–Ω–∫—Ü–∏–∏)
   - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—Ç—Å—Ç—É–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç–∞–≤–∫—É/–∑–∞–º–µ–Ω—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö statements

2. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞** - –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º

### üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### 1. **–ù–ï –ü–ï–†–ï–°–¢–†–ê–ò–í–ê–ï–¢–°–Ø –ò–ù–î–ï–ö–° –ü–û–°–õ–ï –ú–û–î–ò–§–ò–ö–ê–¶–ò–ò** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `tree_modifier.py:61-63` –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
```python
# Rebuild index (simplified - in production might want to update incrementally)
# For now, we'll need to rebuild the entire index
# This is acceptable for the initial implementation
```

**–ù–û –ö–û–î –ù–ï –í–´–ü–û–õ–ù–Ø–ï–¢–°–Ø!** –ü–æ—Å–ª–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ `tree.module` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –Ω–æ:
- `tree.node_map` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ —É–∑–ª—ã (—Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–µ/–∑–∞–º–µ–Ω–µ–Ω–Ω—ã–µ)
- `tree.metadata_map` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- `tree.parent_map` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å `node_id` –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- `cst_find_node`, `cst_get_node_info` –≤–µ—Ä–Ω—É—Ç –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ö–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏ "Node not found" –¥–∞–∂–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–∑–ª–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 59 –≤ tree_modifier.py:
tree.module = modified_module

# –î–û–ë–ê–í–ò–¢–¨:
from .tree_builder import _build_tree_index
# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã
tree.node_map.clear()
tree.metadata_map.clear()
tree.parent_map.clear()
# –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
_build_tree_index(tree)
```

#### 2. **–ù–µ–ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–º–µ–Ω—ã –¥–ª—è SimpleStatementLine**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `_replace_node()` –µ—Å—Ç—å `leave_SimpleStatementLine()`, –Ω–æ –æ–Ω –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç:
```python
def leave_SimpleStatementLine(...):
    # SimpleStatementLine cannot be replaced with multiple statements
    # This case should be handled at a higher level
    return updated_node
```

–ï—Å–ª–∏ –∑–∞–º–µ–Ω—è–µ–º `SimpleStatementLine` –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ statements, —ç—Ç–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
–ù—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–º–µ–Ω—É `SimpleStatementLine` –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ statements —á–µ—Ä–µ–∑ –∑–∞–º–µ–Ω—É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–∑–ª–∞ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É.

#### 3. **–ù–µ–ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤ IndentedBlock**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `_insert_node()` –º–µ—Ç–æ–¥ `leave_IndentedBlock()` –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç:
```python
def leave_IndentedBlock(...):
    # Handle block-level insertions (functions, classes, etc.)
    # Check if this block belongs to the target parent
    # We need to check parent context - this is handled in on_leave
    return updated_node
```

–í—Å—Ç–∞–≤–∫–∞ –≤ –±–ª–æ–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π/–∫–ª–∞—Å—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `on_leave` –¥–ª—è `FunctionDef/ClassDef`, –Ω–æ –Ω–µ –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤.

### ‚ö†Ô∏è –°–ï–†–¨–ï–ó–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

#### 4. **–ù–µ—É–¥–æ–±–Ω—ã–π API –¥–ª—è insert - —Ç—Ä–µ–±—É–µ—Ç—Å—è parent_node_id**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–î–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å `parent_node_id`, –Ω–æ —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞ (`target_node_id`).

**–¢–µ–∫—É—â–∏–π workflow:**
1. –ù–∞–π—Ç–∏ —É–∑–µ–ª —á–µ—Ä–µ–∑ `cst_find_node`
2. –ü–æ–ª—É—á–∏—Ç—å –µ–≥–æ parent —á–µ—Ä–µ–∑ `cst_get_node_info` —Å `include_parent=True`
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å parent –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏

**–ñ–µ–ª–∞–µ–º—ã–π workflow:**
1. –ù–∞–π—Ç–∏ —É–∑–µ–ª —á–µ—Ä–µ–∑ `cst_find_node`
2. –í—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –Ω–µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `target_node_id` –¥–ª—è insert:
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `target_node_id`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –µ–≥–æ parent
- –í—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ—Å–ª–µ/–ø–µ—Ä–µ–¥ `target_node_id` –≤ —Å–ø–∏—Å–∫–µ siblings
- `parent_node_id` –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

#### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è parent**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ parent –ø–æ `node_id`. –ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cst_get_node_info`.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_find_parent_for_node(tree, node_id)` –≤ `tree_modifier.py`.

#### 6. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ—Ä—è–¥–∫–æ–º –æ–ø–µ—Ä–∞—Ü–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —É–∑–µ–ª, –∞ –ø–æ—Ç–æ–º –ø—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –µ–≥–æ parent, `node_id` –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π.

**–†–µ—à–µ–Ω–∏–µ:**
–û–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å (—Å–º. –ø—Ä–æ–±–ª–µ–º—É #1).

### üìù –ú–ï–õ–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø

#### 7. **–£–ª—É—á—à–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö**

–¢–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞ "Node not found" –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –ö–∞–∫–æ–π `node_id` –±—ã–ª –∑–∞–ø—Ä–æ—à–µ–Ω
- –ö–∞–∫–∏–µ —É–∑–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã (–ø–µ—Ä–≤—ã–µ 5)
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

#### 8. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏**

–°–µ–π—á–∞—Å –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–Ω–Ω–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º.

#### 9. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π**

–¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏: `before`/`after` parent. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- `before_node` / `after_node` - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞
- `first` / `last` - –≤ –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û - –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫—É –∏–Ω–¥–µ–∫—Å–∞ –ø–æ—Å–ª–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏**
   - –§–∞–π–ª: `code_analysis/core/cst_tree/tree_modifier.py`
   - –°—Ç—Ä–æ–∫–∞: –ø–æ—Å–ª–µ 59
   - –î–µ–π—Å—Ç–≤–∏–µ: –≤—ã–∑–≤–∞—Ç—å `_build_tree_index(tree)` –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `tree.module`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–ù–û - –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è)

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–º–µ–Ω—ã SimpleStatementLine**
   - –§–∞–π–ª: `code_analysis/core/cst_tree/tree_modifier.py`
   - –ú–µ—Ç–æ–¥: `_replace_node()`
   - –î–µ–π—Å—Ç–≤–∏–µ: –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–º–µ–Ω—É `SimpleStatementLine` –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ statements

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—Å—Ç–∞–≤–∫–∏ –≤ IndentedBlock**
   - –§–∞–π–ª: `code_analysis/core/cst_tree/tree_modifier.py`
   - –ú–µ—Ç–æ–¥: `_insert_node()`
   - –î–µ–π—Å—Ç–≤–∏–µ: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å—Ç–∞–≤–∫—É –≤ `IndentedBlock`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–õ–£–ß–®–ï–ù–ò–Ø - –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)

4. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `target_node_id` –¥–ª—è insert**
   - –§–∞–π–ª: `code_analysis/core/cst_tree/models.py` - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `target_node_id`
   - –§–∞–π–ª: `code_analysis/core/cst_tree/tree_modifier.py` - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É
   - –§–∞–π–ª: `code_analysis/commands/cst_modify_tree_command.py` - –æ–±–Ω–æ–≤–∏—Ç—å schema

5. **–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ parent**
   - –§–∞–π–ª: `code_analysis/core/cst_tree/tree_modifier.py`
   - –§—É–Ω–∫—Ü–∏—è: `_find_parent_for_node(tree, node_id) -> Optional[str]`

6. **–£–ª—É—á—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4 (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û - –¥–ª—è –±—É–¥—É—â–µ–≥–æ)

7. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
8. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π** (`before_node`, `after_node`)

## üîß –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ (–ö–†–ò–¢–ò–ß–ù–û)

**–§–∞–π–ª:** `code_analysis/core/cst_tree/tree_modifier.py`

**–ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 59:**
```python
# Update tree
tree.module = modified_module

# Rebuild index after modification
from .tree_builder import _build_tree_index
tree.node_map.clear()
tree.metadata_map.clear()
tree.parent_map.clear()
_build_tree_index(tree)
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å target_node_id –≤ –º–æ–¥–µ–ª—å

**–§–∞–π–ª:** `code_analysis/core/cst_tree/models.py`

**–í –∫–ª–∞—Å—Å TreeOperation –¥–æ–±–∞–≤–∏—Ç—å:**
```python
target_node_id: Optional[str] = None  # Target node for insert (alternative to parent_node_id)
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 3: –û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é insert

**–§–∞–π–ª:** `code_analysis/core/cst_tree/tree_modifier.py`

**–í `_validate_operation()` –¥–ª—è INSERT:**
```python
elif operation.action == TreeOperationType.INSERT:
    if not operation.code:
        raise ValueError("code required for insert operation")
    # Either parent_node_id or target_node_id must be provided
    if not operation.parent_node_id and not operation.target_node_id:
        raise ValueError("parent_node_id or target_node_id required for insert operation")
    if operation.parent_node_id and operation.parent_node_id not in tree.node_map:
        raise ValueError(f"Parent node not found: {operation.parent_node_id}")
    if operation.target_node_id and operation.target_node_id not in tree.node_map:
        raise ValueError(f"Target node not found: {operation.target_node_id}")
    # ... rest of validation
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 4: –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—Å—Ç–∞–≤–∫–∏

**–§–∞–π–ª:** `code_analysis/core/cst_tree/tree_modifier.py`

**–í `_apply_operation()` –¥–ª—è INSERT:**
```python
elif operation.action == TreeOperationType.INSERT:
    # If target_node_id is provided, find parent automatically
    if operation.target_node_id:
        parent_id = _find_parent_for_node(tree, operation.target_node_id)
        if not parent_id:
            raise ValueError(f"Cannot find parent for target node: {operation.target_node_id}")
        # Insert relative to target node
        return _insert_node_relative(
            module, tree, operation.target_node_id, operation.code, operation.position
        )
    else:
        # Use parent_node_id (existing logic)
        return _insert_node(
            module, tree, operation.parent_node_id, operation.code, operation.position
        )
```

## üìä –û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã #1 (–ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–µ–∫—Å–∞):
- ‚úÖ –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ `cst_find_node`, `cst_get_node_info` –≤–µ—Ä–Ω—É—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚ö†Ô∏è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º #2-3 (–ª–æ–≥–∏–∫–∞ –∑–∞–º–µ–Ω—ã/–≤—Å—Ç–∞–≤–∫–∏):
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ edge cases

### –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è #4 (target_node_id):
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∏–µ workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ú–µ–Ω—å—à–µ –≤—ã–∑–æ–≤–æ–≤ –∫–æ–º–∞–Ω–¥ (–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å parent –æ—Ç–¥–µ–ª—å–Ω–æ)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **–ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
   - –ó–∞–º–µ–Ω–∞ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞
   - –ó–∞–º–µ–Ω–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ statements
   - –í—Å—Ç–∞–≤–∫–∞ –≤ –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü
   - –£–¥–∞–ª–µ–Ω–∏–µ —É–∑–ª–∞

2. **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
   - –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–¥—Ä—è–¥
   - –ó–∞–º–µ–Ω–∞ + –≤—Å—Ç–∞–≤–∫–∞
   - –£–¥–∞–ª–µ–Ω–∏–µ + –≤—Å—Ç–∞–≤–∫–∞

3. **Edge cases:**
   - –ó–∞–º–µ–Ω–∞ SimpleStatementLine –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ statements
   - –í—Å—Ç–∞–≤–∫–∞ –≤ IndentedBlock
   - –í—Å—Ç–∞–≤–∫–∞ –ø–æ—Å–ª–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞ (target_node_id)

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤:**
   - –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `node_map` –∏ `metadata_map` –∞–∫—Ç—É–∞–ª—å–Ω—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `cst_find_node` –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ —É–∑–ª—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `cst_get_node_info` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
