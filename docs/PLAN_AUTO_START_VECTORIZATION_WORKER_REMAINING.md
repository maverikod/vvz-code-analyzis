# –û—Å—Ç–∞–≤—à–∏–µ—Å—è –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –ø—É–Ω–∫—Ç—ã –≤ –ø–ª–∞–Ω–µ

**Author**: Vasiliy Zdanovskiy  
**email**: vasilyvz@gmail.com  
**Date**: 2026-01-09

## –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–ª–∞–Ω –≤ —Ü–µ–ª–æ–º **–ø–æ–ª–Ω—ã–π –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**. –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—É–Ω–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –Ω–æ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —à–∞–≥–∞—Ö.

## ‚úÖ –ß—Ç–æ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ

1. ‚úÖ **Step 0**: –ú–∏–≥—Ä–∞—Ü–∏—è - —É–∫–∞–∑–∞–Ω–æ "No migration needed - test database only"
2. ‚úÖ **Step 4**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ FAISS –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ - –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
3. ‚úÖ **Step 4**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
4. ‚úÖ **Step 6**: PID —Ñ–∞–π–ª –ø—Ä–æ–≤–µ—Ä–∫–∞ - –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
5. ‚úÖ **Step 6**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
6. ‚úÖ **Step 6**: Worker registration name - —É–∫–∞–∑–∞–Ω–æ `"vectorization_universal"`
7. ‚úÖ **Edge Case #8**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã - —É–∫–∞–∑–∞–Ω–æ —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PID —Ñ–∞–π–ª
8. ‚úÖ **MCP Command**: –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ - "Universal worker only"

## ‚ö†Ô∏è –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. Step 6: Restart Function - —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å**: –£–ø–æ–º—è–Ω—É—Ç–æ, –Ω–æ –Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

**–ß—Ç–æ –µ—Å—Ç—å –≤ –ø–ª–∞–Ω–µ**:
- –°—Ç—Ä–æ–∫–∞ 270-271: "Update restart function (if exists) to start universal worker without project_id/dataset_id" –∏ "Remove project_id/dataset_id from restart function closure"

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ Step 6 Details**:
- **Restart function update**:
  - –í `main.py` –µ—Å—Ç—å `_restart_vectorization_worker()` —Ñ—É–Ω–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 1003-1042)
  - –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç closure variables: `_project_id_val`, `_faiss_index_path_val`, `_dataset_id_val`
  - –î–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞:
    1. –£–±—Ä–∞—Ç—å –≤—Å–µ closure variables —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å project_id/dataset_id/faiss_index_path
    2. –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ: `_db_path_val`, `_faiss_dir_val`, `_vector_dim_val`, `_svo_config_val`, `_batch_size_val`, `_poll_interval_val`, `_worker_log_path_val`
    3. –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤ `run_vectorization_worker()`:
       - –£–±—Ä–∞—Ç—å `project_id` –∏ `dataset_id` –∏–∑ args
       - –ó–∞–º–µ–Ω–∏—Ç—å `faiss_index_path` –Ω–∞ `faiss_dir` –≤ args
       - –°–∏–≥–Ω–∞—Ç—É—Ä–∞: `run_vectorization_worker(db_path, faiss_dir, vector_dim, ...)`
    4. –û–±–Ω–æ–≤–∏—Ç—å PID file path: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `vectorization_worker.pid` –≤–º–µ—Å—Ç–æ `{project_id}_{dataset_id}.pid`
    5. –û–±–Ω–æ–≤–∏—Ç—å worker name –≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–º dict: `"vectorization_universal"`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª –≤ Step 6 Details —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è restart function.

### 2. Step 6: Worker Launcher - —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å**: –£–ø–æ–º—è–Ω—É—Ç–æ –≤ "Files to Modify", –Ω–æ –Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ Step 6

**–ß—Ç–æ –µ—Å—Ç—å –≤ –ø–ª–∞–Ω–µ**:
- –°—Ç—Ä–æ–∫–∞ 418-423: –î–µ—Ç–∞–ª–∏ –≤ "Files to Modify" —Ä–∞–∑–¥–µ–ª–µ
- –ù–æ –Ω–µ —É–ø–æ–º—è–Ω—É—Ç–æ –≤ Step 6 Details

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ Step 6 Details**:
- **Worker launcher update**:
  - –§–∞–π–ª `code_analysis/core/worker_launcher.py`
  - –§—É–Ω–∫—Ü–∏—è `start_vectorization_worker()`:
    1. –ò–∑–º–µ–Ω–∏—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É: —É–±—Ä–∞—Ç—å `project_id`, `faiss_index_path`, `dataset_id`; –¥–æ–±–∞–≤–∏—Ç—å `faiss_dir`
    2. –î–æ–±–∞–≤–∏—Ç—å PID file check (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –≤ main.py):
       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ PID —Ñ–∞–π–ª–∞
       - –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–æ—Ü–µ—Å—Å –∂–∏–≤ - –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
       - –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å –º–µ—Ä—Ç–≤ - —É–¥–∞–ª–∏—Ç—å stale PID —Ñ–∞–π–ª
    3. –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤ `run_vectorization_worker()`:
       - –£–±—Ä–∞—Ç—å `project_id` –∏ `dataset_id` –∏–∑ args
       - –ó–∞–º–µ–Ω–∏—Ç—å `faiss_index_path` –Ω–∞ `faiss_dir` –≤ args
    4. –û–±–Ω–æ–≤–∏—Ç—å worker registration:
       - –ò–∑–º–µ–Ω–∏—Ç—å name —Å `f"vectorization_{project_id}"` –Ω–∞ `"vectorization_universal"`
       - –û–±–Ω–æ–≤–∏—Ç—å restart function (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) - —É–±—Ä–∞—Ç—å project_id/dataset_id
    5. –ó–∞–ø–∏—Å–∞—Ç—å PID —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞: `vectorization_worker.pid`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª –≤ Step 6 Details —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è worker_launcher.py.

### 3. Step 6: MCP Command - —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å**: –£–ø–æ–º—è–Ω—É—Ç–æ –≤ "Files to Modify", –Ω–æ –Ω–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ Step 6

**–ß—Ç–æ –µ—Å—Ç—å –≤ –ø–ª–∞–Ω–µ**:
- –°—Ç—Ä–æ–∫–∞ 424-427: –î–µ—Ç–∞–ª–∏ –≤ "Files to Modify" —Ä–∞–∑–¥–µ–ª–µ
- –°—Ç—Ä–æ–∫–∞ 498: "MCP Command `start_worker`: **Universal worker only**"
- –ù–æ –Ω–µ —É–ø–æ–º—è–Ω—É—Ç–æ –≤ Step 6 Details

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ Step 6 Details**:
- **MCP Command update**:
  - –§–∞–π–ª `code_analysis/commands/worker_management_mcp_commands.py`
  - –ö–ª–∞—Å—Å `StartWorkerMCPCommand`:
    1. –û–±–Ω–æ–≤–∏—Ç—å schema (`get_schema()`):
       - –£–±—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `project_id` –∏ `dataset_id` –∏–∑ input schema
       - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞
    2. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥ `execute()`:
       - –£–±—Ä–∞—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è `project_id` –∏ `dataset_id`
       - –£–±—Ä–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è dataset-scoped FAISS index path
       - –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `faiss_dir` –≤–º–µ—Å—Ç–æ `faiss_index_path`
       - –í—ã–∑—ã–≤–∞—Ç—å `start_vectorization_worker()` —Å `faiss_dir` –≤–º–µ—Å—Ç–æ `faiss_index_path`
       - –£–±—Ä–∞—Ç—å –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ª–æ–≥–∏–∫—É —Å–≤—è–∑–∞–Ω–Ω—É—é —Å project_id/dataset_id
    3. –û–±–Ω–æ–≤–∏—Ç—å docstrings –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª –≤ Step 6 Details —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è MCP –∫–æ–º–∞–Ω–¥—ã.

## üìã –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã—Ö –ø—É–Ω–∫—Ç–æ–≤

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π)

1. **Step 6**: –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è restart function –≤ `main.py`
   - –£–±—Ä–∞—Ç—å closure variables –¥–ª—è project_id/dataset_id/faiss_index_path
   - –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤ `run_vectorization_worker()` –±–µ–∑ project_id/dataset_id
   - –û–±–Ω–æ–≤–∏—Ç—å PID file path –∏ worker name

2. **Step 6**: –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `worker_launcher.py`
   - –ò–∑–º–µ–Ω–∏—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—É —Ñ—É–Ω–∫—Ü–∏–∏
   - –î–æ–±–∞–≤–∏—Ç—å PID file check
   - –û–±–Ω–æ–≤–∏—Ç—å worker registration

3. **Step 6**: –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è MCP –∫–æ–º–∞–Ω–¥—ã `StartWorkerMCPCommand`
   - –£–±—Ä–∞—Ç—å project_id/dataset_id –∏–∑ schema
   - –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É execute()

### –í–∞–∂–Ω–æ (–º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ –≤—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `run_vectorization_worker()` –æ–±–Ω–æ–≤–ª–µ–Ω—ã
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–ª–∞–Ω **–ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤**. –û—Å—Ç–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ —Ç—Ä–µ–º –ø—É–Ω–∫—Ç–∞–º –≤ Step 6:
- Restart function –¥–µ—Ç–∞–ª–∏
- Worker launcher –¥–µ—Ç–∞–ª–∏  
- MCP command –¥–µ—Ç–∞–ª–∏

–≠—Ç–∏ –¥–µ—Ç–∞–ª–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ Step 6 Details –∫–∞–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã, –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å –∏ —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ –≤—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç–∞–∫ –∫–∞–∫ –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ —É–∂–µ –æ–ø–∏—Å–∞–Ω–∞ –≤ "Files to Modify").

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∏ –¥–µ—Ç–∞–ª–∏ –≤ Step 6 –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã –ø–ª–∞–Ω–∞, –Ω–æ –ø–ª–∞–Ω —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ç–∞–ª–µ–Ω –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

