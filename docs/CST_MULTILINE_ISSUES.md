# –ü—Ä–æ–±–ª–µ–º—ã —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –≤ CST –∫–æ–º–∞–Ω–¥–∞—Ö

**Author:** Vasiliy Zdanovskiy  
**email:** vasilyvz@gmail.com  
**Date:** 2025-01-27

## üîç –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ –í–ê–ñ–ù–û: –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ:**
- –ü–∞—Ä—Å–∏–Ω–≥ –±–ª–æ–∫–∞ —Å `if` –∫–∞–∫ –º–æ–¥—É–ª—å: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –û–±–µ—Ä—Ç–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢

**–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `_parse_code_snippet()`, –∞ –≤ **–ø–µ—Ä–µ–¥–∞—á–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ MCP**.

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ —á–µ—Ä–µ–∑ MCP

**–°–∏–º–ø—Ç–æ–º—ã:**
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–º–µ–Ω–∏—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –Ω–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –±–ª–æ–∫ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ MCP –∫–æ–º–∞–Ω–¥—É –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:
```
Invalid code syntax for replace: Syntax Error @ 2:9.
parser error: error at 1:8: expected one of (, *, +, -, ...
    if not engine:
    ^
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–ü—Ä–æ–±–ª–µ–º–∞ **–ù–ï** –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `_parse_code_snippet()` (–æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ), –∞ –≤:

1. **–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ —á–µ—Ä–µ–∑ JSON/MCP:**
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (—ç–º–æ–¥–∑–∏ ‚ùå) –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
   - –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
   - –û—Ç—Å—Ç—É–ø—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

2. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ JSON:**
   - JSON —Ç—Ä–µ–±—É–µ—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è `\n`, `\t`, `"` –∏ —Ç.–¥.
   - –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ JSON –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–û–±—Ä–∞–±–æ—Ç–∫–µ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫:**
   - –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ JSON –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è

**–ü—Ä–∏–º–µ—Ä:**
```python
# –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∞ 136):
engine_factory = ServerEngineFactory()

# –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
engine = ServerEngineFactory.get_engine("hypercorn")
if not engine:
    print("‚ùå Hypercorn engine not available", file=sys.stderr)
    sys.exit(1)
```

–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø (8 –ø—Ä–æ–±–µ–ª–æ–≤), –ø–æ–ª—É—á–∞–µ—Ç:
```python
engine = ServerEngineFactory.get_engine("hypercorn")
if not engine:
    print("‚ùå Hypercorn engine not available", file=sys.stderr)
    sys.exit(1)
```

–ü—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ –º–æ–¥—É–ª—å - **FAIL** (if –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è).

–ü—ã—Ç–∞–µ—Ç—Å—è –æ–±–µ—Ä–Ω—É—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏—é:
```python
def _temp():
    engine = ServerEngineFactory.get_engine("hypercorn")
    if not engine:
        print("‚ùå Hypercorn engine not available", file=sys.stderr)
        sys.exit(1)
```

–ù–æ –ø–∞—Ä—Å–µ—Ä –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–∞–¥–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏.

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ

**–ü—Ä–∏—á–∏–Ω–∞:**
`_parse_code_snippet()` –ø–∞—Ä—Å–∏—Ç –∫–æ–¥ **–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ**, –±–µ–∑ —É—á–µ—Ç–∞:
- –†–µ–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –æ—Ç—Å—Ç—É–ø–æ–≤ –≤ –º–µ—Å—Ç–µ –∑–∞–º–µ–Ω—ã
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –±–ª–æ–∫–∞ (—Ñ—É–Ω–∫—Ü–∏—è, –∫–ª–∞—Å—Å, –º–æ–¥—É–ª—å)
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è vs —É—Ä–æ–≤–Ω—è —Ñ—É–Ω–∫—Ü–∏–∏

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ö–æ–¥ —Å `if/try/except/for/while` –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –∫–∞–∫ –º–æ–¥—É–ª—å
- –û–±–µ—Ä—Ç–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π statements
- –°–ª–æ–∂–Ω—ã–µ –±–ª–æ–∫–∏ —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –Ω–µ –ø–∞—Ä—Å—è—Ç—Å—è

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫

**–ö–æ–¥:**
```python
# –°—Ç—Ä–æ–∫–∏ 115-123
normalized_lines = []
for line in lines:
    if line.strip():  # Non-empty line
        if len(line) >= min_indent:
            normalized_lines.append(line[min_indent:])
        else:
            normalized_lines.append(line)
    else:  # Empty line
        normalized_lines.append("")
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ `""`, –Ω–æ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —ç—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–ª–æ–∫–∞.

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–¢–µ–∫—É—â–∏–π fallback:**
1. –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–∫ –º–æ–¥—É–ª—å
2. –û–±–µ—Ä—Ç–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é `def _temp():`
3. –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–∫ single statement

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –®–∞–≥ 2 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (try/except —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –±–ª–æ–∫–∞–º–∏)
- –®–∞–≥ 3 —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å–ª–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã

## üîß –†–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –£–ª—É—á—à–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –æ—Ç—Å—Ç—É–ø–æ–≤

**–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥:**
- –£–¥–∞–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
- –ü—ã—Ç–∞–µ—Ç—Å—è –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ –º–æ–¥—É–ª—å

**–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –æ—Ç—Å—Ç—É–ø–æ–≤ —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞
2. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–¥ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è
3. –ü–∞—Ä—Å–∏—Ç—å —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### –†–µ—à–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥

**–ò–¥–µ—è:**
–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —É–∑–µ–ª, —É—Ä–æ–≤–µ–Ω—å –æ—Ç—Å—Ç—É–ø–æ–≤) –≤ `_parse_code_snippet()`.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
def _parse_code_snippet(
    code: str, 
    context_indent: int = 0,
    context_type: Optional[str] = None  # "module", "function", "class"
) -> list[cst.BaseStatement]:
```

### –†–µ—à–µ–Ω–∏–µ 3: –£–ª—É—á—à–∏—Ç—å –æ–±–µ—Ä—Ç–∫—É –≤ —Ñ—É–Ω–∫—Ü–∏—é

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
func_wrapper = f"def _temp():\n{func_body}"
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 4 –ø—Ä–æ–±–µ–ª–∞ –º–æ–≥—É—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏
- –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–£–ª—É—á—à–µ–Ω–∏–µ:**
- –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (try/except, if/else)

### –†–µ—à–µ–Ω–∏–µ 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —É–º–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
–í–º–µ—Å—Ç–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–∞—Ä—Å–∏—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥, –º–æ–∂–Ω–æ:
1. –í—Ä–µ–º–µ–Ω–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –≤ —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
2. –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫
3. –ò–∑–≤–ª–µ—á—å –Ω—É–∂–Ω—ã–µ statements

## üìã –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–∏–º–µ—Ä 1: –ó–∞–º–µ–Ω–∞ –Ω–∞ –±–ª–æ–∫ —Å if

**–í—Ö–æ–¥–Ω–æ–π –∫–æ–¥:**
```python
engine_factory = ServerEngineFactory()
```

**–ó–∞–º–µ–Ω–∞ –Ω–∞:**
```python
engine = ServerEngineFactory.get_engine("hypercorn")
if not engine:
    print("Error")
    sys.exit(1)
```

**–û—à–∏–±–∫–∞:**
```
Syntax Error @ 2:9. parser error: error at 1:8: expected one of ...
    if not engine:
    ^
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–∞—Ä—Å–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ –º–æ–¥—É–ª—å, –Ω–æ `if` –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

### –ü—Ä–∏–º–µ—Ä 2: –ó–∞–º–µ–Ω–∞ –Ω–∞ –±–ª–æ–∫ —Å try/except

**–í—Ö–æ–¥–Ω–æ–π –∫–æ–¥:**
```python
asyncio.run(engine.run())
```

**–ó–∞–º–µ–Ω–∞ –Ω–∞:**
```python
try:
    ssl_engine_config = build_server_ssl_config(config.to_dict())
    if ssl_engine_config:
        server_config.update(ssl_engine_config)
except ValueError as e:
    print(f"Error: {e}", file=sys.stderr)
    sys.exit(1)
```

**–û—à–∏–±–∫–∞:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è - –ø–∞—Ä—Å–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å `try/except` –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

## ‚úÖ –†–ï–®–ï–ù–ò–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `code_lines` –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `code_lines: Optional[List[str]]` –≤ `TreeOperation`
2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ `_parse_code_snippet()` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫
3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ schema –∫–æ–º–∞–Ω–¥—ã `cst_modify_tree` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `code_lines`
4. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: `code` –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º JSON (`\n`, `\t`, `"` –∏ —Ç.–¥.)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ—Ç—Å—Ç—É–ø—ã, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏)
- ‚úÖ –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞
- ‚úÖ –ü—Ä–æ—â–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ MCP/JSON

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```json
{
  "tree_id": "abc123",
  "operations": [
    {
      "action": "replace",
      "node_id": "stmt:main:SimpleStatementLine:136:8-136:46",
      "code_lines": [
        "engine = ServerEngineFactory.get_engine(\"hypercorn\")",
        "if not engine:",
        "    print(\"‚ùå Hypercorn engine not available\", file=sys.stderr)",
        "    sys.exit(1)",
        "",
        "# Prepare server configuration",
        "server_config = {",
        "    \"host\": config.model.server.host,",
        "    \"port\": config.model.server.port,",
        "    \"log_level\": \"info\",",
        "    \"reload\": False,",
        "}",
        "",
        "engine.run_server(app, server_config)"
      ]
    }
  ]
}
```

**–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ (—Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è):**

```json
{
  "code": "engine = ServerEngineFactory.get_engine(\"hypercorn\")\nif not engine:\n    print(\"‚ùå Error\", file=sys.stderr)\n    sys.exit(1)"
}
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. **–î–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `code_lines`:**
   - –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞
   - –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ç—Å—Ç—É–ø—ã –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
   - –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º

2. **–î–ª—è –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `code`:**
   - –ü—Ä–æ—â–µ –∏ –∫–æ—Ä–æ—á–µ
   - –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

3. **–ù–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:**
   - –ë—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   - `code_lines` –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ `code`

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ `_parse_code_snippet`:

1. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 96-124):**
   - –ù–∞—Ö–æ–¥–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø
   - –£–¥–∞–ª—è–µ—Ç –µ–≥–æ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

2. **–ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–∫ –º–æ–¥—É–ª—å (—Å—Ç—Ä–æ–∫–∏ 126-129):**
   - `cst.parse_module(normalized)`
   - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è

3. **–û–±–µ—Ä—Ç–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é (—Å—Ç—Ä–æ–∫–∏ 130-149):**
   - –î–æ–±–∞–≤–ª—è–µ—Ç `def _temp():` –∏ 4 –ø—Ä–æ–±–µ–ª–∞
   - –ü–∞—Ä—Å–∏—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç body —Ñ—É–Ω–∫—Ü–∏–∏
   - **–ü–†–û–ë–õ–ï–ú–ê**: –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–æ–≤

4. **Fallback –Ω–∞ single statement (—Å—Ç—Ä–æ–∫–∏ 151-159):**
   - `cst.parse_statement(normalized)`
   - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Å—Ç–∞:

- **–°—Ç—Ä–æ–∫–∞ 124:** `normalized = "\n".join(normalized_lines)` - –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- **–°—Ç—Ä–æ–∫–∞ 136:** –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 4 –ø—Ä–æ–±–µ–ª–∞ - –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **–°—Ç—Ä–æ–∫–∞ 140:** `func_wrapper = f"def _temp():\n{func_body}"` - –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –±–ª–æ–∫–æ–≤
