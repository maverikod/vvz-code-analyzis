# Schema Synchronization - Clarification Questions

**Author**: Vasiliy Zdanovskiy  
**email**: vasilyvz@gmail.com  
**Date**: 2026-01-10

## Questions Before Implementation

### Q1: BackupManager root_dir для БД

**Проблема**: BackupManager требует `root_dir` (проектный корень), но БД может находиться:
- В проекте: `{project_root}/data/code_analysis.db`
- В отдельном storage: `{storage_path}/code_analysis.db` (из конфига)

**Вопрос**: Как определить `root_dir` для BackupManager из пути к БД?

**Варианты**:
- A) Извлекать из пути БД: `db_path.parent.parent` (предполагая `data/code_analysis.db`)
- B) Передавать `root_dir` в SQLiteDriver через config
- C) Использовать путь к БД как `root_dir` (хранить бекапы рядом с БД)
- D) Если БД в storage - использовать storage_dir как root_dir

**Рекомендация**: Вариант C - хранить бекапы БД рядом с самой БД (в `{db_path.parent}/backups/`), не в `old_code/`.

---

### Q2: Бекап при первой синхронизации

**Вопрос**: Нужно ли создавать бекап если БД пустая (первая синхронизация, создание схемы)?

**Варианты**:
- A) Да - всегда создавать бекап перед любыми изменениями схемы
- B) Нет - бекап только если БД не пустая (есть данные)
- C) Нет - бекап только если есть изменения (не просто создание схемы)

**Рекомендация**: Вариант B - бекап только если БД не пустая (есть таблицы с данными).

---

### Q3: Обработка ошибок синхронизации

**Вопрос**: Что делать если синхронизация схемы провалилась?

**Варианты**:
- A) Блокировать подключение - raise exception, не подключаться
- B) Продолжать работу - логировать ошибку, но разрешить подключение
- C) Retry - повторить попытку синхронизации
- D) Зависит от типа ошибки - критичные блокируют, некритичные логируются

**Рекомендация**: Вариант D - критичные ошибки (несовместимость схемы) блокируют, некритичные (отсутствие индекса) логируются.

---

### Q4: Одновременные подключения

**Вопрос**: Как избежать конфликтов если несколько процессов подключаются одновременно и пытаются синхронизировать схему?

**Варианты**:
- A) Использовать файловый lock на время синхронизации
- B) Первый процесс синхронизирует, остальные ждут
- C) Каждый процесс проверяет версию после синхронизации
- D) DBWorker обрабатывает синхронизацию последовательно (уже есть очередь)

**Рекомендация**: Вариант D - DBWorker уже обрабатывает запросы последовательно, синхронизация будет атомарной.

---

### Q5: Версия схемы для существующих БД

**Вопрос**: Какая версия должна быть установлена для существующих БД без таблицы `db_settings`?

**Варианты**:
- A) "0.0.0" - означает "старая схема, нужна синхронизация"
- B) "1.0.0" - текущая версия (предполагаем что схема актуальна)
- C) Определять по структуре - анализировать таблицы и определять версию
- D) Не устанавливать версию, синхронизировать всегда

**Рекомендация**: Вариант A - "0.0.0" означает "неизвестная версия, нужна проверка и синхронизация".

---

### Q6: Миграция данных при пересоздании таблицы

**Вопрос**: Что делать если данные несовместимы с новым типом колонки при пересоздании таблицы?

**Варианты**:
- A) Пропустить несовместимые строки, логировать предупреждения
- B) Попытаться конвертировать (TEXT -> INTEGER если возможно)
- C) Ошибка - откатить изменения, не пересоздавать таблицу
- D) Создать таблицу с новым типом, данные перенести как TEXT, потом конвертировать

**Рекомендация**: Вариант B - попытаться конвертировать, если невозможно - пропустить строку с предупреждением.

---

### Q7: Создание db_settings в _create_schema()

**Вопрос**: Должна ли таблица `db_settings` создаваться в `_create_schema()` или в `sync_schema()`?

**Проблема**: 
- Если в `_create_schema()` - как быть с существующими БД без этой таблицы?
- Если в `sync_schema()` - как получить версию для сравнения?

**Варианты**:
- A) В `_create_schema()` - всегда создавать, если не существует
- B) В `sync_schema()` - создавать при первой синхронизации
- C) В обоих - `_create_schema()` создает для новых БД, `sync_schema()` создает для старых

**Рекомендация**: Вариант C - `_create_schema()` создает для новых БД, `sync_schema()` проверяет и создает если отсутствует.

---

### Q8: Начальная версия SCHEMA_VERSION

**Вопрос**: Какая должна быть начальная версия `SCHEMA_VERSION`?

**Варианты**:
- A) "1.0.0" - первая версия
- B) "0.1.0" - начальная версия
- C) Определить текущую версию на основе существующей схемы

**Рекомендация**: Вариант A - "1.0.0" как первая версия с явной синхронизацией схемы.

---

## Summary

Ожидаемые ответы:
1. **Q1**: Вариант C - бекапы БД рядом с БД
2. **Q2**: Вариант B - бекап только если БД не пустая
3. **Q3**: Вариант D - зависит от типа ошибки
4. **Q4**: Вариант D - DBWorker обрабатывает последовательно
5. **Q5**: Вариант A - "0.0.0" для старых БД
6. **Q6**: Вариант B - конвертировать если возможно
7. **Q7**: Вариант C - создавать в обоих местах
8. **Q8**: Вариант A - "1.0.0"
